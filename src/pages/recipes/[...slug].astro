---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const recipes = await getCollection("recipes");
  return recipes.map((entry) => ({
    params: { slug: entry.id.replace(/\.mdx?$/, "") },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const { data } = entry;

const difficultyLabel = (d: number) => ["", "简单 Easy", "中等 Medium", "进阶 Advanced"][d];

function formatDuration(sec: number): string {
  if (sec >= 60) {
    const min = Math.floor(sec / 60);
    const remain = sec % 60;
    return remain > 0 ? `${min}min ${remain}s` : `${min}min`;
  }
  return `${sec}s`;
}

function toISO8601(sec: number): string {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  let str = "PT";
  if (h) str += `${h}H`;
  if (m) str += `${m}M`;
  if (s) str += `${s}S`;
  return str === "PT" ? "PT0S" : str;
}

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Recipe",
  name: data.title,
  description: data.description,
  author: { "@type": "Organization", name: "理科生下厨房 SciCook" },
  recipeCategory: data.category,
  recipeCuisine: "Chinese",
  recipeYield: `${data.servings} 份`,
  totalTime: toISO8601(data.totalTimeSec),
  recipeIngredient: data.ingredients.map((i) => `${i.name} ${i.amountG}${i.unit || "g"}`),
  recipeInstructions: data.steps.map((s, i) => ({
    "@type": "HowToStep",
    position: i + 1,
    text: s.action,
  })),
};
---

<BaseLayout title={data.title} description={data.description}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <article class="mx-auto max-w-3xl px-6 py-12">
    <!-- Header -->
    <header class="mb-10">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-block rounded-full bg-brand-500/15 border border-brand-500/30 px-3 py-1 text-xs font-mono text-brand-400">
          {data.category}
        </span>
        <span class="text-xs text-gray-500 font-mono">
          Lv.{data.difficulty} {difficultyLabel(data.difficulty)}
        </span>
      </div>
      <h1 class="text-3xl font-bold text-gray-50 sm:text-4xl">{data.title}</h1>
      <p class="mt-3 text-lg text-gray-400">{data.description}</p>

      <!-- Quick stats bar -->
      <div class="mt-6 flex flex-wrap items-center gap-6 rounded-lg border border-gray-800 bg-gray-900/50 px-5 py-3 font-mono text-sm">
        <div>
          <span class="text-gray-600">servings:</span>
          <span class="text-gray-300 ml-1">{data.servings}</span>
        </div>
        <div>
          <span class="text-gray-600">time:</span>
          <span class="text-gray-300 ml-1">{formatDuration(data.totalTimeSec)}</span>
        </div>
        <div>
          <span class="text-gray-600">peak_temp:</span>
          <span class="text-amber-400 ml-1">{data.peakTempCelsius}°C</span>
        </div>
      </div>
    </header>

    <!-- Ingredients -->
    <section class="mb-10">
      <h2 class="text-xl font-bold text-gray-100 mb-4">
        <span class="font-mono text-brand-500">#</span> 食材清单
      </h2>
      <div class="rounded-lg border border-gray-800 overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-900/80">
              <th class="px-4 py-2.5 text-left font-mono text-xs text-gray-500">食材</th>
              <th class="px-4 py-2.5 text-left font-mono text-xs text-gray-500">用量</th>
              <th class="px-4 py-2.5 text-left font-mono text-xs text-gray-500">分类</th>
              <th class="px-4 py-2.5 text-left font-mono text-xs text-gray-500 hidden sm:table-cell">备注</th>
            </tr>
          </thead>
          <tbody>
            {data.ingredients.map((ing, i) => (
              <tr class:list={[i % 2 === 0 ? "bg-gray-900/30" : ""]}>
                <td class="px-4 py-2 text-gray-200">{ing.name}</td>
                <td class="px-4 py-2 font-mono text-amber-400">
                  {ing.amountG}{ing.unit || "g"}
                </td>
                <td class="px-4 py-2">
                  <span class:list={[
                    "rounded px-2 py-0.5 text-xs",
                    ing.role === "主料" ? "bg-brand-500/15 text-brand-400" :
                    ing.role === "调味" ? "bg-amber-500/15 text-amber-400" :
                    "bg-gray-800 text-gray-400"
                  ]}>
                    {ing.role}
                  </span>
                </td>
                <td class="px-4 py-2 text-xs text-gray-500 hidden sm:table-cell">{ing.notes || "-"}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Steps (SOP) -->
    <section class="mb-10">
      <h2 class="text-xl font-bold text-gray-100 mb-4">
        <span class="font-mono text-brand-500">#</span> SOP 步骤
      </h2>
      <div class="space-y-3">
        {data.steps.map((step, i) => (
          <div class="rounded-lg border border-gray-800 bg-gray-900/30 p-4">
            <div class="flex items-start gap-3">
              <span class="flex h-7 w-7 shrink-0 items-center justify-center rounded-md bg-brand-500/15 font-mono text-xs font-bold text-brand-400">
                {(i + 1).toString().padStart(2, "0")}
              </span>
              <div class="flex-1">
                <p class="text-gray-200">{step.action}</p>
                {/* Params */}
                {(step.durationSec || step.tempCelsius) && (
                  <div class="mt-2 flex gap-4 font-mono text-xs">
                    {step.durationSec && (
                      <span class="text-gray-500">
                        time: <span class="text-gray-300">{formatDuration(step.durationSec)}</span>
                      </span>
                    )}
                    {step.tempCelsius && (
                      <span class="text-gray-500">
                        temp: <span class="text-amber-400">{step.tempCelsius}°C</span>
                      </span>
                    )}
                  </div>
                )}
                {/* Science note */}
                {step.scienceNote && (
                  <div class="mt-2 rounded-md border border-brand-500/20 bg-brand-500/5 px-3 py-2 text-xs text-gray-400">
                    <span class="font-mono text-brand-500">// </span>{step.scienceNote}
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- MDX content (extra notes, debugging guide) -->
    <section class="prose">
      <Content />
    </section>
  </article>
</BaseLayout>
